# default.conf - wr-cc conf template file
#
# Copyright (c) 2020-2022 Wind River Systems, Inc.
#
# The right to copy, distribute, modify or otherwise make use
# of this software may be licensed only pursuant to the terms
# of an applicable Wind River license agreement.
#
# DESCRIPTION
# This is wr-cc conf template file
#
# Usage:
#   export WIND_CC_SYSROOT=<VSB_DIR>
# 	wr-cc ...
#

Ignore  = -dkm -rtp -lkm -fuse-ld
Ignore += --static-crt -nodefaultlibs -no-pie -print-multiarch -rdynamic --print-multiarch -print-search-dirs --print-search-dirs -print-target-triple  -fno-asan

[-shared-libgcc | -static-libgcc]    error -shared-libgcc and -static-libgcc are not supported

require WIND_HOME
require WIND_BASE
require WIND_VX7_HOST_TYPE
require WIND_CC_SYSROOT

[WIND_SBOM_ENABLE] SBOM = true

[-rtp | (!-dkm & !-lkm)] RTP = true
[-dkm | -lkm]            KERNEL = true
[-dkm]                   DKM = true
[-lkm]                   LKM = true

RTP_DISABLE = 

[!wr-bin-utility & RTP & !NoFiles & RTP_DISABLE] error RTP is not supported
[RTP & KERNEL]                 error cannot specify both -rtp and -dkm/-lkm

[-shared | -Bshareable]                           OptionShared = true
[-static | -Bstatic|-non_shared]                  OptionStatic = true
[-Bdynamic | -call_shared]                        OptionDynamic = true
[-r]                                              OptionPartial = true
[OptionDynamic | OptionShared | OptionPartial]    OptionNonStatic = true

[OptionPartial]                         Partial = true
[OptionShared & !OptionPartial]         Shared = true
[OptionStatic & !OptionNonStatic]       Static = true
[--static-crt]                          Static = true
[!(Shared | Static | Partial) & RTP]    Dynamic = true
[!(Shared | Static | Partial) & KERNEL] Partial = true
[KERNEL & (Static | Shared | Dynamic)]  error kernel module only support partial link

[(-fPIC | -fpic)] PIC = true
[!PIC] NON_PIC = true

[Win64 & !BINDIR]   BINDIR = $(WIND_HOME)/compilers/llvm-15.0.0.1/WIN64/bin
[Linux64 & !BINDIR] BINDIR = $(WIND_HOME)/compilers/llvm-15.0.0.1/LINUX64/bin

LINKER_LD        = ldppc
LINKER_LLD       = ld.lld
VSB_LINKER_IS_LLD = 
[-fuse-ld_ld & -fuse-ld_lld] error cannot specify both -fuse-ld=ld and -fuse-ld=lld
[-fuse-ld_lld & KERNEL]      error -fuse-ld=lld is not supported for DKMs or LKMs
[(VSB_LINKER_IS_LLD & !-fuse-ld_ld) | -fuse-ld_lld] LINKER_IS_LLD = true
[!LINKER_IS_LLD] BIN_linker = $(LINKER_LD)
[LINKER_IS_LLD]  BIN_linker = $(LINKER_LLD)

VSB_ASAN_IS_ENABLED = 
# "-fno-asan" could be used for disabling ASAN for library but not for RTP
[VSB_ASAN_IS_ENABLED & !-fno-asan] ASAN_ENABLE = true
[ASAN_ENABLE]                      SANITIZER_FLAGS = -fsanitize=address -mllvm -asan-force-dynamic-shadow=true -fno-omit-frame-pointer
[ASAN_ENABLE & C++]                SANITIZER_LIBS_CXX = -lclang_rt.asan_cxx-powerpc
[ASAN_ENABLE]                      SANITIZER_LIBS = -whole-archive -lclang_rt.asan-powerpc $(SANITIZER_LIBS_CXX) -no-whole-archive

PROG_cc = $(BINDIR)/clang$(EXE)
[WIND_WR_CC] PROG_cc = $(WIND_WR_CC)
PROG_c++ = $(BINDIR)/clang++$(EXE)
[WIND_WR_CXX] PROG_c++ = $(WIND_WR_CXX)
PROG_cpp = $(BINDIR)/clang-cpp$(EXE)
PROG_ld = $(BINDIR)/$(BIN_linker)$(EXE) -m elf32ppc --secure-plt
PROG_ld_KERNEL = $(BINDIR)/$(LINKER_LD)$(EXE) -m elf32ppc
PROG_ar = $(BINDIR)/arppc$(EXE)
PROG_size = $(BINDIR)/sizeppc$(EXE)
PROG_nm = $(BINDIR)/nmppc$(EXE)
PROG_objcopy = $(BINDIR)/objcopyppc$(EXE)
PROG_ranlib = $(BINDIR)/ranlibppc$(EXE)
PROG_readelf = $(BINDIR)/readelfppc$(EXE)
PROG_strip = $(BINDIR)/stripppc$(EXE)
PROG_objdump = $(BINDIR)/objdumpppc$(EXE)
[RTP] PROG_as = $(BINDIR)/asppc$(EXE) -a32
[KERNEL] PROG_as = $(BINDIR)/asppc$(EXE) -a32
PROG_dep = $(WIND_BASE)/host/$(WIND_VX7_HOST_TYPE)/bin/vxsbomdep
PROG_map = $(WIND_BASE)/host/$(WIND_VX7_HOST_TYPE)/bin/vxsbommap
PROG_rm = $(WIND_BASE)/host/$(WIND_VX7_HOST_TYPE)/bin/rm$(EXE) -f

CC = $(PROG_cc)
[C++]  CC = $(PROG_c++)
[CPP]  CC = $(PROG_cpp)
LD = $(PROG_ld)

[Verbose]           OPT_CC_V = -v
[Verbose & NoFiles] OPT_CC_V += -Wno-unused-command-line-argument

[-print-target-triple | -dumpmachine] print powerpc-wrs-vxworks
[-print-search-dirs | --print-search-dirs] print programs: = $(WIND_BASE)/host/$(WIND_VX7_HOST_TYPE)/bin
[RTP & (-print-search-dirs | --print-search-dirs)] print libraries: = $(WIND_CC_SYSROOT)/usr/lib/common$(:)$(WIND_CC_SYSROOT)/usr/3pp/develop/lib$(:)$(WIND_CC_SYSROOT)/usr/3pp/develop/usr/lib
[KERNEL & (-print-search-dirs | --print-search-dirs)] print libraries: = $(WIND_CC_SYSROOT)/krnl/llvm$(:)$(WIND_CC_SYSROOT)/krnl/PPCE6500/common

STDC = -std=c11
STDCXX = -std=c++14
[NON_PIC] MC_MODEL_RTP = 
[PIC] MC_MODEL_RTP = 
MC_MODEL_KERNEL = 

OPT_CC_DEP =
[SBOM & !-M & !-MD & !-MMD] OPT_CC_DEP = -MD

[RTP] Compile = $(CC) -mcpu=e6500 -mno-altivec -D_VX_CPU=_VX_PPCE6500 -mlong-double-64 -mno-spe -D_WRS_PPC_NO_MCRXR -mhard-float -D__ppc -D__ppc__ -mstrict-align -msecure-plt --target=ppc32 $(MC_MODEL_RTP) -fno-strict-aliasing -fno-builtin -fno-unwind-tables -fno-asynchronous-unwind-tables -nostdlibinc -nostdinc++ -fwrapv -D__ELF__   -Wno-unused-command-line-argument -mllvm -two-entry-phi-node-folding-threshold=2 -D__vxworks -D__VXWORKS__  -D__RTP__  -D_VX_TOOL_FAMILY=llvm -D_VX_TOOL=llvm -D_USE_INIT_ARRAY -fasm $(SANITIZER_FLAGS) -D_VSB_CONFIG_FILE=\"$(WIND_CC_SYSROOT)/h/config/vsbConfig.h\"  -D_VSB_PUBLIC_HDR_DIR=$(WIND_CC_SYSROOT)/usr/h/public $(OPT_CC_V) $* -I. -I$(WIND_CC_SYSROOT)/usr/h/published/UTILS_UNIX -I$(WIND_CC_SYSROOT)/share/h -isystem$(WIND_CC_SYSROOT)/usr/h/public  -I$(WIND_CC_SYSROOT)/usr/3pp/develop/usr/include $(OPT_CC_DEP)
[KERNEL] Compile = $(CC) -mcpu=e6500 -mno-altivec -D_VX_CPU=_VX_PPCE6500 -mlong-double-64 -mno-spe -D_WRS_PPC_NO_MCRXR -mhard-float -D__ppc -D__ppc__ -mstrict-align -mlongcall --target=ppc32 $(MC_MODEL_KERNEL) -fno-strict-aliasing -ftls-model=local-exec -fno-builtin -fno-unwind-tables -fno-asynchronous-unwind-tables -nostdlibinc -nostdinc++ -fwrapv -D__ELF__   -Wno-unused-command-line-argument -mllvm -two-entry-phi-node-folding-threshold=2 -D__vxworks -D__VXWORKS__   -D_WRS_KERNEL -DTOOL_FAMILY=llvm -DTOOL=llvm -D_USE_INIT_ARRAY -D_VSB_CONFIG_FILE=\"$(WIND_CC_SYSROOT)/h/config/vsbConfig.h\" -D_VSB_PUBLIC_HDR_DIR=$(WIND_CC_SYSROOT)/krnl/h/public $(OPT_CC_V) $* -I. -I$(WIND_CC_SYSROOT)/krnl/h/published/UTILS_UNIX -I$(WIND_CC_SYSROOT)/share/h -isystem$(WIND_CC_SYSROOT)/krnl/h/public -I$(WIND_CC_SYSROOT)/krnl/3pp/develop/usr/include $(OPT_CC_DEP)

[SBOM] POST_COMPILE_1 =  $(PROG_dep) -d \"$(:DEP_FILENAME)\" -o \"$(:OUT_FILENAME)\"
[SBOM & WIND_SBOM_DEBUG & !-M & !-MD & !-MMD] POST_COMPILE_2 = $(PROG_rm) $(:DEP_FILENAME)

[C++] LibCplusPlus = -lcplusplus
[C++] LibToolCplus = -lllvmcplus
[DKM & !C++] DkmCtdt = $(WIND_CC_SYSROOT)/krnl/llvm/ctdtc.o
[DKM & C++]  DkmCtdt  = $(WIND_CC_SYSROOT)/krnl/llvm/ctdtcplus.o

[Dynamic] LibDl = -ldl

[Shared | Dynamic]  LD_MODE = --as-needed
[-rdynamic]         LD_MODE += -export-dynamic
[KERNEL & Partial & !-r]         LD_MODE = -r

[Verbose] OPT_LD_V = -v

[--static-crt] OPT_STATIC_CRT = -Bstatic

[SBOM & !-Map] LINK_MAP_OPTION = -Map $(:OUT_FILENAME).map

RTP_SCRIPT = rtp.ld
SHL_SCRIPT = shlib.ld
[LINKER_IS_LLD] RTP_SCRIPT = rtp.lld
[LINKER_IS_LLD] SHL_SCRIPT = shlib.lld

[Static] LD_ARGS_RTP = 
[Dynamic] LD_ARGS_RTP = 
[Dynamic | Shared] LD_RPATH_LINK = -rpath-link $(WIND_CC_SYSROOT)/usr/lib/common/ -rpath-link $(WIND_CC_SYSROOT)/usr/3pp/develop/lib -rpath-link $(WIND_CC_SYSROOT)/usr/3pp/develop/usr/lib
[LINKER_IS_LLD] LD_TOOL_FLAGS_RTP_lld = -z norelro --no-rosegment
[Static | Dynamic] Link = $(LD) $(LD_ARGS_RTP) $(LD_MODE) --defsym __wrs_rtp_base=0x80000000 -u __wr_need_frame_add -u __tls__ $(LD_TOOL_FLAGS_RTP_lld) -T$(WIND_CC_SYSROOT)/usr/ldscripts/$(RTP_SCRIPT) $(WIND_CC_SYSROOT)/usr/lib/common/crt0.o $(SANITIZER_LIBS) $* $(LD_RPATH_LINK) -L$(WIND_CC_SYSROOT)/usr/lib/common/ -L$(WIND_CC_SYSROOT)/usr/3pp/develop/lib -L$(WIND_CC_SYSROOT)/usr/3pp/develop/usr/lib $(OPT_STATIC_CRT) $(LINK_MAP_OPTION) --start-group -lc -lc_internal -lllvm -lnet -lunix -lregex $(LibDl) $(LibCplusPlus) $(LibToolCplus) --end-group

[LINKER_IS_LLD] LD_TOOL_FLAGS_SHL_lld = -z norelro --no-rosegment
[Shared] Link = $(LD)   $(LD_MODE) $* -Bdynamic --exclude-libs libc_internal_s.a -u __init -u __fini -u __wr_need_frame_add $(LD_TOOL_FLAGS_SHL_lld) -L$(WIND_CC_SYSROOT)/usr/lib/common $(LD_RPATH_LINK) -L$(WIND_CC_SYSROOT)/usr/3pp/develop/lib -L$(WIND_CC_SYSROOT)/usr/3pp/develop/usr/lib -lc -lc_internal_s  -lllvm -lnet -lunix -lregex $(LibCplusPlus) $(LibToolCplus) $(LINK_MAP_OPTION) -T$(WIND_CC_SYSROOT)/usr/ldscripts/$(SHL_SCRIPT)

[Partial & RTP] Link = $(LD) $(LD_MODE) $*
[Partial & DKM] Link = $(PROG_ld_KERNEL) -X $(LD_MODE) --eh-frame-hdr --force-group-allocation  -T$(WIND_CC_SYSROOT)/krnl/ldscripts/dkm.ld $(DkmCtdt) $*
[Partial & LKM] Link = $(PROG_ld_KERNEL) -X $(LD_MODE) --eh-frame-hdr $*

[SBOM] POST_LINK_1 = $(PROG_map) -m \"$(:MAP_FILENAME)\" -o \"$(:OUT_FILENAME)\"
[SBOM & WIND_SBOM_DEBUG & !-Map] POST_LINK_2 = $(PROG_rm) $(:MAP_FILENAME)
